<?php
session_start();
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: chrome-extension://*');
header('Access-Control-Allow-Credentials: true');

require_once '../includes/config.php';
require_once '../includes/db.php';

// Verificar autenticaciÃ³n
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['error' => 'No autenticado']);
    exit;
}

$db = getDB();

// Obtener URLs del usuario
$stmt = $db->prepare("
    SELECT 
        u.short_code,
        u.original_url,
        u.created_at,
        u.clicks,
        u.active,
        COALESCE(cd.domain, ?) as domain
    FROM urls u
    LEFT JOIN custom_domains cd ON u.domain_id = cd.id
    WHERE u.user_id = ? AND u.active = 1
    ORDER BY u.created_at DESC
    LIMIT 1000
");

$stmt->execute([$_SERVER['HTTP_HOST'], $_SESSION['user_id']]);
$urls = $stmt->fetchAll();

// Formatear respuesta
$response = [];
foreach ($urls as $url) {
    $response[] = [
        'short_code' => $url['short_code'],
        'short_url' => 'https://' . $url['domain'] . '/' . $url['short_code'],
        'original_url' => $url['original_url'],
        'created_at' => $url['created_at'],
        'clicks' => intval($url['clicks']),
        'title' => $url['short_code'] // Puedes mejorar esto
    ];
}

echo json_encode($response);
?>
